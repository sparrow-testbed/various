<?xml version="1.0" encoding="EUC-KR" ?> 
<service>
	<method name="bl_getPayBugetGiveList">
		SELECT
			SPGL.STATUS_CD,
			GETCODETEXT1('M1015', SPGL.STATUS_CD, 'KO') AS STATUS_NM,
			NVL(SPGL.SIGN_STATUS, 'T') AS SIGN_STATUS,
            GETCODETEXT1('M100', NVL(SPGL.SIGN_STATUS, 'T'), 'KO') AS SIGN_STATUS_TEXT,
			SPGL.PAY_SEND_NO,
			SPGL.PAY_AMT,
			SPGL.VENDOR_CODE,
			GETCOMPANYNAMELOC(SPGL.HOUSE_CODE,SPGL.VENDOR_CODE,'S') AS VENDOR_NAME,
			SPGL.SIGNER_NO,
			/*GETUSERNAME(SPGL.HOUSE_CODE, NVL(SPGL.SIGNER_NO, SPGL.ADD_USER_ID), 'LOC') AS SIGNER_NM,*/
			GETUSERNAME(SPGL.HOUSE_CODE, SPGL.ADD_USER_ID, 'LOC') AS SIGNER_NM,
			SPGL.SIGNER_FLAG,
			SPGL.ADD_USER_ID,
			TXDT.TAX_NO,
			CONVERT_DATE(TXHD.TAX_DATE) AS TAX_DATE,
			CASE 
		       	WHEN
		       		TXHD.TAX_APP_NO IS NULL
		       	THEN
		       		'RP'
				ELSE
					'P'
			END AS TAX_GUBUN,
			TXHD.PROGRESS_CODE,
			SB.PUBCODE,
			CASE 
		       	WHEN
		       		SPGL.STATUS_CD = '30'
		       		OR
		       		SPGL.STATUS_CD = '40'
		       		OR
		       		SPGL.STATUS_CD = '80'
		       	THEN
		       		CONVERT_DATE(SPGL.CHANGE_DATE)		       		
				ELSE
					' '
			END AS CHANGE_DATE,
			SPGL.RTN_SIGNER_NO,
			SPGL.BEFORE_SIGN_NO,
			CASE 
		       	WHEN
		       		SPGL.STATUS_CD = '30'
		       		OR
		       		SPGL.STATUS_CD = '40'
		       		OR
		       		SPGL.STATUS_CD = '80'
		       	THEN
		       		CONVERT_DATE(SPGL.CHANGE_DATE)		       		
				ELSE
					'9999/12/31 '
			END AS CHANGE_DATE_ORDERBY
		FROM
			SPY1GL SPGL,
			SPY1LN SPLN,
			ICOYTXHD TXHD,
			ICOYTXDT TXDT,
			(
				SELECT
					RESSEQ,
					PUBCODE,
					LOADSTATUS,
					NTS_ISSUEID
				FROM
					SALEEBILL
				WHERE
					LOADSTATUS  = 1
			) SB,
			ICOMMTGL MTGL
		WHERE SPGL.HOUSE_CODE  = SPLN.HOUSE_CODE
		  AND SPGL.PAY_SEND_NO = SPLN.PAY_SEND_NO
		  AND SPLN.HOUSE_CODE  = TXDT.HOUSE_CODE
       	  AND SPLN.TAX_NO      = TXDT.TAX_NO  
       	  AND SPLN.TAX_SEQ     = TXDT.TAX_SEQ
       	  AND TXHD.HOUSE_CODE  = TXDT.HOUSE_CODE
		  AND TXHD.TAX_NO      = TXDT.TAX_NO  
		  AND TXHD.TAX_NO      = SB.RESSEQ 
		  
		  AND TXDT.HOUSE_CODE  = MTGL.HOUSE_CODE 
		  AND TXDT.ITEM_CODE     = MTGL.ITEM_NO 
		   
		  <![CDATA[  
	      AND SPGL.VENDOR_CODE = $S{vendor_code}
	      AND TXDT.TAX_NO      = $S{tax_no}								
	      AND TXHD.TAX_DATE 	BETWEEN $S{inv_start_date}
	      AND $S{inv_end_date}          
	      AND TXHD.PROGRESS_CODE IN ('P','E')
	      AND SPGL.DEL_YN      = 'N'
	      AND SPGL.STATUS_CD   = $S{status_cd}
	      AND NVL(SPGL.SIGNER_NO, SPGL.ADD_USER_ID) = $S{purchaser_id}
	      
	      AND MTGL.MATERIAL_TYPE       = $S{MATERIAL_TYPE}
		  AND (MTGL.MATERIAL_CTRL_TYPE = $S{MATERIAL_CTRL_TYPE} OR MTGL.MATERIAL_CTRL_TYPE = MTGL.MATERIAL_TYPE ||'000')
		  AND MTGL.MATERIAL_CLASS1     = $S{MATERIAL_CLASS1}
		  AND MTGL.MATERIAL_CLASS2     = $S{MATERIAL_CLASS2}
				
			]]>
		GROUP BY
			SPGL.HOUSE_CODE,    SPGL.STATUS_CD,     SPGL.PAY_SEND_NO, SPGL.PAY_AMT,     SPGL.VENDOR_CODE,
			SPGL.SIGNER_NO,     SPGL.SIGNER_FLAG,   SPGL.ADD_USER_ID, TXDT.TAX_NO,      TXHD.TAX_DATE,
			TXHD.TAX_APP_NO,    TXHD.PROGRESS_CODE, SB.PUBCODE,       SPGL.CHANGE_DATE, SPGL.ADD_USER_ID,
			SPGL.RTN_SIGNER_NO, SPGL.BEFORE_SIGN_NO,SPGL.SIGN_STATUS
		ORDER BY
		    CHANGE_DATE_ORDERBY DESC,
		    SIGN_STATUS DESC,
		    STATUS_NM DESC,
		    CHANGE_DATE DESC,
			PAY_SEND_NO DESC
	</method>
	
	<method name="updateSpy1glManualAccountKind">
		UPDATE
			SPY1GL
		SET
			STATUS_CD      = '80',
			CHANGE_DATE    = TO_CHAR(SYSDATE, 'YYYYMMDD'),
			CHANGE_TIME    = TO_CHAR(SYSDATE, 'HH24MISS'),
			CHANGE_USER_ID = ${ADD_USER_ID}
		WHERE
			HOUSE_CODE  = ${HOUSE_CODE}
		AND
			PAY_SEND_NO = ${PAY_SEND_NO}
		AND
			DEL_YN      = 'N'
	</method>
	
	<method name="selectSpy1List">
		SELECT
			GL.HOUSE_CODE,   GL.PAY_SEND_NO,         GL.VENDOR_CODE,                   GL.DEPOSITOR_NAME,         GL.BANK_CODE,
			GL.BANK_ACCT,    GL.PAY_AMT,             GL.SIGNER_FLAG,                   GL.SIGNER_NO,              GL.SIGNER_BIO,
			GL.WORK_KIND,    GL.BMSBMSYY,            GL.SOGSOGCD,                      GL.ASTASTGB,               GL.MNGMNGNO,
			GL.BSSBSSNO,     GL.APPAPPYY,            GL.BMSSRLNO,                      GL.APPAPPNO,               GL.APPAPPAM,
			GL.JUMJUM_CD,    GL.IGJM_CD,             GL.BDSBDSCD,                      GL.BDSBDSNM,               GL.USE_KIND,
			GL.DEAL_AREA,    GL.DURABLE_YEAR,        NVL(GL.DEAL_DEBT,0) AS DEAL_DEBT, GL.ACCOUNTKIND,            GL.DEAL_KIND,
			GL.TRM_RTN_SQNO, GL.USER_TRM_NO,         GL.STATUS_CD,                     GL.ADD_DATE,               GL.ADD_TIME,
			GL.ADD_USER_ID,  GL.CHANGE_DATE,         GL.CHANGE_TIME,                   GL.CHANGE_USER_ID,         GL.TCP_STATE,
			GL.WEB_STATE,    GL.MANUAL_ACCOUNT_KIND, GL.DEL_YN,                                                   
			LN.PAY_SEND_SEQ, LN.TAX_NO,              LN.TAX_SEQ,                       LN.JUMJUJMCD,              LN.IGJMCD,
			LN.PMKPMKCD,     LN.CNT,                 LN.AMT,                           LN.APPAPPAM AS APPAPPAMDT, LN.DOSUNQNO,
			LN.MODEL_NO
		FROM
			SPY1GL GL
		INNER JOIN SPY1LN LN ON GL.HOUSE_CODE = LN.HOUSE_CODE AND GL.PAY_SEND_NO = LN.PAY_SEND_NO
		WHERE
			GL.HOUSE_CODE  = ${session.HOUSE_CODE}
		AND
			GL.PAY_SEND_NO = ${PAY_SEND_NO}
	</method>
	
	<method name="updateIcoytxdtSpycheck">
		UPDATE
			ICOYTXDT
		SET
			SPY_CHECK = ${SPY_CHECK}
		WHERE
			HOUSE_CODE = ${HOUSE_CODE}
		AND
			TAX_NO     = ${TAX_NO}
		AND
			TAX_SEQ    = ${TAX_SEQ}
	</method>
	
	<method name="selectIcoytxdtSpyCheckList">
		SELECT DISTINCT
			SPY_CHECK
		FROM
			ICOYTXDT
		WHERE
			HOUSE_CODE = ${HOUSE_CODE}
		AND
			TAX_NO     = ${TAX_NO}
	</method>
	
	<method name="updateIcoytxhdProgressCodes">	
		UPDATE
			ICOYTXHD
		SET
			CHANGE_DATE    = TO_CHAR(SYSDATE,'YYYYMMDD'),
			CHANGE_TIME    = TO_CHAR(SYSDATE,'HH24MISS'),
			CHANGE_USER_ID = ${CHANGE_USER_ID},  
			PROGRESS_CODE  = ${PROGRESS_CODE}		  
		WHERE
			HOUSE_CODE = ${HOUSE_CODE}   
		AND
			TAX_NO = ${TAX_NO}	  		
	</method>
	
	<method name="updateSpy1glStatusCd03">
		UPDATE
			SPY1GL
		SET
			STATUS_CD      = '95',
			CHANGE_DATE    = TO_CHAR(SYSDATE, 'YYYYMMDD'),
			CHANGE_TIME    = TO_CHAR(SYSDATE, 'HH24MISS'),
			CHANGE_USER_ID = ${ADD_USER_ID}
		WHERE
			HOUSE_CODE  = ${HOUSE_CODE}
		AND
			PAY_SEND_NO = ${PAY_SEND_NO}
		AND
			DEL_YN      = 'N'
	</method>
	
	<method name="selectSpy1glInfo">
		SELECT
			PYGL.HOUSE_CODE,    PYGL.PAY_SEND_NO,         PYGL.VENDOR_CODE,     PYGL.DEPOSITOR_NAME, PYGL.BANK_CODE,
			PYGL.BANK_ACCT,     PYGL.PAY_AMT,             PYGL.SIGNER_FLAG,     PYGL.SIGNER_NO,      PYGL.SIGNER_BIO,
			PYGL.WORK_KIND,     PYGL.BMSBMSYY,            PYGL.SOGSOGCD,        PYGL.ASTASTGB,       PYGL.MNGMNGNO,
			PYGL.BSSBSSNO,      PYGL.APPAPPYY,            PYGL.BMSSRLNO,        PYGL.APPAPPNO,       PYGL.APPAPPAM,
			PYGL.JUMJUM_CD,     PYGL.IGJM_CD,             PYGL.BDSBDSCD,        PYGL.BDSBDSNM,       PYGL.USE_KIND,
			PYGL.DEAL_AREA,     PYGL.DURABLE_YEAR,        PYGL.DEAL_DEBT,       PYGL.ACCOUNTKIND,    PYGL.DEAL_KIND,
			PYGL.TRM_RTN_SQNO,  PYGL.USER_TRM_NO,         PYGL.STATUS_CD,       PYGL.ADD_DATE,       PYGL.ADD_TIME,
			PYGL.ADD_USER_ID,   PYGL.CHANGE_DATE,         PYGL.CHANGE_TIME,     PYGL.CHANGE_USER_ID, PYGL.TCP_STATE,
			PYGL.WEB_STATE,     PYGL.MANUAL_ACCOUNT_KIND, VNGL.VENDOR_NAME_LOC, VNGL.IRS_NO,         LUSR.USER_NAME_LOC,
			PYGL.RTN_SIGNER_NO, PYGL.BEFORE_SIGN_NO,      
			MNGN.TEXT2                                            AS MNGMNGNM,
			BSSN.TEXT2                                            AS BSSBSSNM,
			JUMC.DEPT_NAME_LOC                                    AS JUMJUM_NM,
			LUSR2.USER_NAME_LOC                                   AS BEFORE_SIGN_NAME,
			GETCODETEXT1('M1015', PYGL.STATUS_CD, 'KO')           AS STATUS_NM,
			GETICOMCODE1(PYGL.HOUSE_CODE, 'M349', PYGL.BANK_CODE) AS BANK_NAME,
			GETCODETEXT1('M805', PYGL.SOGSOGCD,  'KO')            AS SOGSOGNM,
			GETCODETEXT1('M800', PYGL.ASTASTGB,  'KO')            AS ASTASTNM,
			GETCODETEXT1('M804', PYGL.USE_KIND, 'KO')             AS USE_KIND_NM,
			GETCODETEXT1('M803', PYGL.DEAL_KIND, 'KO')            AS DEAL_KIND_NM,			
			(
				CASE
					WHEN
						PYGL.TCP_TIME IS NULL
					THEN
						'F'
					WHEN
						SYSDATE - TO_DATE(
							SUBSTRING(
								NVL(TCP_TIME, '20150101'
								), 0, 8
							) || '000000',
							'YYYYMMDDHH24MISS'
						) > 1
					THEN
						'F'
					ELSE
						'T'
				END
			) AS CANCLE_ABLE,
			NVL(PYGL.SIGN_STATUS, 'T') AS SIGN_STATUS,
			GETUSERNAME(PYGL.HOUSE_CODE, PYGL.ADD_USER_ID, 'LOC') AS SIGNER_NM,
			PYGL.CCLT_RSN_DSCD                                    AS CCLT_RSN_DSCD,
			GETCODETEXT1('M816', PYGL.CCLT_RSN_DSCD, 'KO')        AS CCLT_RSN_DSCD_NM,
			PYGL.CCLT_RSN_CNTN                                    AS CCLT_RSN_CNTN,
			PYGL.OLD_USER_TRM_NO                                  AS OLD_USER_TRM_NO
		FROM
			SPY1GL PYGL
		INNER JOIN      ICOMVNGL VNGL  ON PYGL.HOUSE_CODE = VNGL.HOUSE_CODE  AND PYGL.VENDOR_CODE    = VNGL.VENDOR_CODE
		LEFT OUTER JOIN ICOMLUSR LUSR  ON PYGL.HOUSE_CODE = LUSR.HOUSE_CODE  AND PYGL.SIGNER_NO      = LUSR.USER_ID
		LEFT OUTER JOIN ICOMLUSR LUSR2 ON PYGL.HOUSE_CODE = LUSR2.HOUSE_CODE AND PYGL.BEFORE_SIGN_NO = LUSR2.USER_ID
		INNER JOIN      SCODE    MNGN  ON PYGL.HOUSE_CODE = MNGN.HOUSE_CODE  AND PYGL.ASTASTGB       = MNGN.TEXT3
		INNER JOIN      SCODE    BSSN  ON PYGL.HOUSE_CODE = BSSN.HOUSE_CODE  AND PYGL.MNGMNGNO       = BSSN.TEXT4
		LEFT OUTER JOIN ICOMOGDP JUMC  ON PYGL.HOUSE_CODE = JUMC.HOUSE_CODE  AND PYGL.JUMJUM_CD      = JUMC.DEPT
		WHERE
			PYGL.HOUSE_CODE   = ${HOUSE_CODE}
		AND
			PYGL.PAY_SEND_NO  = ${PAY_SEND_NO}
		AND
			MNGN.TYPE         = 'M801'
		AND
			MNGN.CODE         = PYGL.MNGMNGNO
		AND
			MNGN.USE_FLAG     = 'Y'
		AND
			MNGN.DEL_FLAG     = 'N'
		AND
			BSSN.TYPE         = 'M802'
		AND
			BSSN.CODE         = PYGL.BSSBSSNO
		AND
			BSSN.USE_FLAG     = 'Y'
		AND
			BSSN.DEL_FLAG     = 'N'
		AND
			NVL(JUMC.COMPANY_CODE, 'WOORI') = 'WOORI' 
		AND
		    NVL(JUMC.STATUS, 'A')       != 'D'
		AND
			PYGL.DEL_YN       = 'N'
	</method>
	
	<method name="selectSpy1lnList">
		SELECT
			SPLN.HOUSE_CODE
			,SPLN.PAY_SEND_NO
			,SPLN.PAY_SEND_SEQ
			,SPLN.TAX_NO
			,SPLN.TAX_SEQ
			,SPLN.JUMJUJMCD
			,SPLN.PMKPMKCD
			,SPLN.CNT
			,SPLN.AMT
			,SPLN.APPAPPAM
			,SPLN.DOSUNQNO
			,CONVERT_DATE(SPLN.ADD_DATE) AS ADD_DATE
			,SPLN.ADD_TIME
			,SPLN.ADD_USER_ID
			,CONVERT_DATE(SPLN.CHANGE_DATE) AS CHANGE_DATE
			,SPLN.CHANGE_TIME
			,SPLN.CHANGE_USER_ID
			,JUMC.DEPT_NAME_LOC
			,MTGL.DESCRIPTION_LOC
			,PODT.SPECIFICATION
			,OGIL.ILGAE_CD AS IGJM_CD
			,TXDT.REMARK
			,SPLN.MODEL_NO
		FROM
			SPY1LN SPLN 
		INNER JOIN ICOMOGDP JUMC ON SPLN.HOUSE_CODE = JUMC.HOUSE_CODE AND SPLN.JUMJUJMCD = JUMC.DEPT
		INNER JOIN ICOMMTGL MTGL ON SPLN.HOUSE_CODE = MTGL.HOUSE_CODE AND SPLN.PMKPMKCD  = MTGL.ITEM_NO
		INNER JOIN ICOYTRDT TRDT ON SPLN.HOUSE_CODE = TRDT.HOUSE_CODE AND TRDT.TAX_NO    = SPLN.TAX_NO  AND TRDT.TAX_SEQ = SPLN.TAX_SEQ
		INNER JOIN ICOYTXDT TXDT ON SPLN.HOUSE_CODE = TXDT.HOUSE_CODE AND TXDT.TAX_NO    = SPLN.TAX_NO  AND TXDT.TAX_SEQ = SPLN.TAX_SEQ
		INNER JOIN ICOYPODT PODT ON TRDT.HOUSE_CODE = PODT.HOUSE_CODE AND TRDT.PO_NO     = PODT.PO_NO   AND TRDT.PO_SEQ  = PODT.PO_SEQ
		INNER JOIN ICOMOGIL OGIL ON SPLN.HOUSE_CODE = OGIL.HOUSE_CODE AND SPLN.JUMJUJMCD = OGIL.DEPT
		WHERE
			SPLN.HOUSE_CODE   = ${HOUSE_CODE}
		AND
			SPLN.PAY_SEND_NO  = ${PAY_SEND_NO}
		AND
			JUMC.COMPANY_CODE =  'WOORI' 
		AND
		    JUMC.STATUS       != 'D'
		AND
		    MTGL.MATERIAL_TYPE IN ('02','04')
		ORDER BY
			SPLN.PAY_SEND_SEQ ASC
	</method>

	<method name="updateSpy1glManualAccountKindCancle">
		UPDATE
			SPY1GL
		SET
			STATUS_CD      = '85',
			CHANGE_DATE    = TO_CHAR(SYSDATE, 'YYYYMMDD'),
			CHANGE_TIME    = TO_CHAR(SYSDATE, 'HH24MISS'),
			CHANGE_USER_ID = ${CHANGE_USER_ID}
		WHERE
			HOUSE_CODE  = ${HOUSE_CODE}
		AND
			PAY_SEND_NO = ${PAY_SEND_NO}
		AND
			DEL_YN      = 'N'
	</method>
	
	<method name="updateSpy1glRtnSignerNo">
		UPDATE
			SPY1GL
		SET
			STATUS_CD      = '40',
			RTN_SIGNER_NO  = ${RTN_SIGNER_NO},
			CCLT_RSN_DSCD  = ${CCLT_RSN_DSCD},
			CCLT_RSN_CNTN  = ${CCLT_RSN_CNTN},
			CHANGE_DATE    = TO_CHAR(SYSDATE, 'YYYYMMDD'),
			CHANGE_TIME    = TO_CHAR(SYSDATE, 'HH24MISS'),
			CHANGE_USER_ID = ${CHANGE_USER_ID}
		WHERE
			HOUSE_CODE  = ${HOUSE_CODE}
		AND
			PAY_SEND_NO = ${PAY_SEND_NO}
		AND
			DEL_YN      = 'N'
	</method>
	
	<method name="updateSpy1gInfoBeforeSign">
		UPDATE
			SPY1GL
		SET
			STATUS_CD      = '03',
			CHANGE_DATE    = TO_CHAR(SYSDATE, 'YYYYMMDD'),
			CHANGE_TIME    = TO_CHAR(SYSDATE, 'HH24MISS'),
			CHANGE_USER_ID = ${ADD_USER_ID}
		WHERE
			HOUSE_CODE  = ${HOUSE_CODE}
		AND
			PAY_SEND_NO = ${PAY_SEND_NO}
		AND
			DEL_YN      = 'N'
	</method>
	
	<method name="updateSpy1gInfoBeforeSignReject">
		UPDATE
			SPY1GL
		SET
			STATUS_CD      = '90',
			CHANGE_DATE    = TO_CHAR(SYSDATE, 'YYYYMMDD'),
			CHANGE_TIME    = TO_CHAR(SYSDATE, 'HH24MISS'),
			CHANGE_USER_ID = ${ADD_USER_ID}
		WHERE
			HOUSE_CODE  = ${HOUSE_CODE}
		AND
			PAY_SEND_NO = ${PAY_SEND_NO}
		AND
			DEL_YN      = 'N'
	</method>
</service>