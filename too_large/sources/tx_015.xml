<?xml version="1.0" encoding="EUC-KR" ?>
<service>
	<method name="bl_getPayList">
		SELECT
			TAX_NO,       TAX_SEQ,     DELY_TO_LOCATION, DELY_TO_LOCATION_NM, IGJM_CD,
			ACCOUNT_CODE, ACCOUNT_NM,  ITEM_NO,          ITEM_NM,             SPECIFICATION,
			VENDOR_CODE,  VENDOR_NAME, PY_CNT,           ADD_DATE,            AMT,
			VAT_AMT,      TOT_AMT,     PURCHASE_NAME,    SUBJECT,             RD_DATE,LG_ATT_NAME,
            MD_ATT_NAME,  SM_ATT_NAME, ATTRIBUTE_NAME,   PR_USER_ID,          PR_USER_NAME,  
            PR_USER_DEPT_CODE,         PR_USER_DEPT_NAME,PROGRESS_CODE    
		FROM
			(
				SELECT
					TXHD.TAX_NO,
					TXDT.TAX_SEQ,
					PODT.DELY_TO_LOCATION AS DELY_TO_LOCATION,
					GETDEPTNAME(PODT.HOUSE_CODE, PODT.COMPANY_CODE, PODT.DELY_TO_LOCATION, 'LOC' ) AS DELY_TO_LOCATION_NM,
					OGIL.ILGAE_CD AS IGJM_CD,
					MTGL.ACCOUNT_CODE AS ACCOUNT_CODE,
					MTGL.ACCOUNT_NM AS ACCOUNT_NM,
					TRDT.ITEM_NO AS ITEM_NO,
					MTGL.DESCRIPTION_LOC AS ITEM_NM,
					PODT.SPECIFICATION AS SPECIFICATION,
					TRHD.VENDOR_CODE,
					GETCOMPANYNAMELOC(TRHD.HOUSE_CODE,TRHD.VENDOR_CODE,'S') AS VENDOR_NAME,
					(
						SELECT
							COUNT(1)
						FROM
							SPY1LN PYLN
						INNER JOIN SPY1GL PYGL ON PYLN.HOUSE_CODE = PYGL.HOUSE_CODE AND PYLN.PAY_SEND_NO = PYGL.PAY_SEND_NO
						WHERE
							PYLN.HOUSE_CODE = TXDT.HOUSE_CODE
						AND
							PYLN.TAX_NO     = TXDT.TAX_NO
						AND
							PYLN.TAX_SEQ    = TXDT.TAX_SEQ
						AND
		       				PYGL.DEL_YN     = 'N'
					) AS PY_CNT,
					CONVERT_DATE(TRHD.ADD_DATE) AS ADD_DATE,
					--TXHD.SUP_AMT AS AMT,
					--TXHD.VAT_AMT,
					--TXHD.SUP_AMT + TXHD.VAT_AMT AS TOT_AMT,
					TXDT.SUP_AMT AS AMT,
					TXDT.VAT_AMT,
					TXDT.SUP_AMT + TXDT.VAT_AMT AS TOT_AMT,
					GETUSERNAME(
						TRDT.HOUSE_CODE,
						(
							SELECT
								PURCHASE_ID
							FROM
								ICOYIVHD
							WHERE
								INV_NO = TRDT.INV_NO
						),
						'LOC'
					) AS PURCHASE_NAME,
					PRHD.SUBJECT
					,PRHD.ADD_USER_ID PR_USER_ID --구매요청자ID
				    ,GETUSERNAME(TRDT.HOUSE_CODE,PRHD.ADD_USER_ID,'LOC') AS PR_USER_NAME
				    ,GETDEPTCODEBYID(TRDT.HOUSE_CODE,'WOORI',PRHD.ADD_USER_ID) AS PR_USER_DEPT_CODE
				    -- ,GETDEPTNAMEBYID(TRDT.HOUSE_CODE,'WOORI',PRHD.ADD_USER_ID) AS PR_USER_DEPT_NAME
				    ,(SELECT DEPT_NAME_LOC FROM ICOMOGDP WHERE DEPT = PRHD.DEMAND_DEPT) AS PR_USER_DEPT_NAME
				    ,CONVERT_DATE(IVDT.RD_DATE) RD_DATE
				    ,getIcomcode2('000','M040',MTGL.MATERIAL_TYPE)          AS LG_ATT_NAME
				    ,getIcomcode2('000','M041',MTGL.MATERIAL_CTRL_TYPE)     AS MD_ATT_NAME
				    ,getIcomcode2('000','M042',MTGL.MATERIAL_CLASS1)        AS SM_ATT_NAME
				    ,getIcomcode2('000','M122',MTGL.MATERIAL_CLASS2)        AS ATTRIBUTE_NAME
				    ,CASE WHEN (TXHD.PROGRESS_CODE = 'E') THEN '완료' ELSE '미완료' END PROGRESS_CODE
			FROM
				ICOYTRHD TRHD
			INNER JOIN      ICOYTRDT TRDT ON TRHD.HOUSE_CODE = TRDT.HOUSE_CODE AND TRHD.PAY_NO           = TRDT.PAY_NO
			INNER JOIN      ICOYPODT PODT ON TRDT.HOUSE_CODE = PODT.HOUSE_CODE AND TRDT.PO_NO            = PODT.PO_NO  AND TRDT.PO_SEQ = PODT.PO_SEQ
			LEFT OUTER JOIN ICOMOGIL OGIL ON PODT.HOUSE_CODE = OGIL.HOUSE_CODE AND PODT.DELY_TO_LOCATION = OGIL.DEPT
			INNER JOIN      ICOYTXHD TXHD ON TRDT.HOUSE_CODE = TXHD.HOUSE_CODE AND TRDT.TAX_NO           = TXHD.TAX_NO
			INNER JOIN      ICOYTXDT TXDT ON TRDT.HOUSE_CODE = TXDT.HOUSE_CODE AND TRDT.TAX_NO           = TXDT.TAX_NO AND TRDT.TAX_SEQ = TXDT.TAX_SEQ
			INNER JOIN      ICOMMTGL MTGL ON TRDT.HOUSE_CODE = MTGL.HOUSE_CODE AND TRDT.ITEM_NO          = MTGL.ITEM_NO
			INNER JOIN      ICOYPRHD PRHD ON PODT.HOUSE_CODE = PRHD.HOUSE_CODE AND PODT.PR_NO            = PRHD.PR_NO
			INNER JOIN      ICOYIVDT IVDT ON TRDT.HOUSE_CODE = IVDT.HOUSE_CODE AND TRDT.INV_NO           = IVDT.INV_NO AND TRDT.INV_SEQ = IVDT.INV_SEQ
			WHERE TRHD.HOUSE_CODE  = ${session.HOUSE_CODE}
		   	AND TXHD.PROGRESS_CODE IN ('P','E')
		   	AND TXHD.KTGRM = '05'
	<![CDATA[  
			AND TXHD.COMPANY_CODE = $S{vendor_code}										
			AND TXHD.TAX_NO       = $S{tax_no}								
			AND TXHD.TAX_DATE 	BETWEEN $S{inv_start_date}
				AND $S{inv_end_date}          
			AND TXHD.PROGRESS_CODE = $S{progress_code}	
			AND EXISTS (SELECT '1' FROM ICOYIVHD WHERE INV_NO = TRDT.INV_NO AND PURCHASE_ID = $S{purchase_id})
			AND TXHD.PROGRESS_CODE LIKE '%' ||  $S{PROGRESS_CODE} || '%'
	]]>   			  			 
		)
	WHERE
		PY_CNT = 0
	ORDER BY
		ADD_DATE DESC,
		TAX_NO   DESC
	</method>
</service>
